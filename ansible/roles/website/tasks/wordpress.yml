---
- name: Download WordPress core
  become_user: "{{ site_user }}"
  ansible.builtin.command: wp core download
  args:
    chdir: "{{ site_home }}/files"
    creates: "{{ site_home }}/files/wp-includes/version.php"

- name: Create wp-config.php
  become_user: "{{ site_user }}"
  ansible.builtin.command: >
    wp config create
    --dbhost='{{ db_host }}'
    --dbname={{ db_name }}
    --dbuser={{ db_user }}
    --dbpass={{ db_pass }}
    --dbprefix={{ db_prefix }}
    --dbcharset=utf8mb4
  args:
    chdir: "{{ site_home }}/files"
    creates: "{{ site_home }}/files/wp-config.php"

- name: Check if WordPress is installed
  become_user: "{{ site_user }}"
  ansible.builtin.command: wp core is-installed
  args:
    chdir: "{{ site_home }}/files"
  register: wp_installed
  failed_when: false
  changed_when: false

- name: Install WordPress
  become_user: "{{ site_user }}"
  ansible.builtin.command: >
    wp core install
    --url=http://{{ domain }}
    --title='Site Title'
    --admin_user='{{ admin_user }}'
    --admin_email='{{ admin_email }}'
    --admin_password='{{ admin_password }}'
    --skip-email
  args:
    chdir: "{{ site_home }}/files"
  when: wp_installed.rc != 0

- name: Get current permalink structure
  become_user: "{{ site_user }}"
  ansible.builtin.command: wp option get permalink_structure
  args:
    chdir: "{{ site_home }}/files"
  register: current_permalink
  changed_when: false
  failed_when: false

- name: Set permalink structure
  become_user: "{{ site_user }}"
  ansible.builtin.command: wp rewrite structure '/%postname%/'
  args:
    chdir: "{{ site_home }}/files"
  when: current_permalink.stdout != '/%postname%/'

- name: Flush cache
  become_user: "{{ site_user }}"
  ansible.builtin.command: wp cache flush
  args:
    chdir: "{{ site_home }}/files"
  changed_when: false
