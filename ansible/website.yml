---
- name: Setup WordPress Website
  hosts: all:!localhost
  become: true
  gather_facts: false

  # Base variables (safe defaults)
  vars:
    db_host: localhost

  # Compute dynamic variables after --extra-vars are loaded
  pre_tasks:
    - name: Generate random credentials and set dynamic facts
      ansible.builtin.set_fact:
        site_user: "{{ system_name }}"
        site_group: "{{ system_name }}"
        site_home: "/sites/{{ domain }}"
        db_name: "{{ system_name }}"
        db_user: "{{ system_name }}"
        db_pass: "{{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}"
        db_prefix: "{{ lookup('password', '/dev/null length=4 chars=ascii_lowercase') }}_"
        admin_user: "{{ wp_admin_user }}"
        admin_email: "{{ wp_admin_email }}"
        admin_password: "{{ wp_admin_password }}"
      when: system_name is defined and domain is defined
      tags: ["website"]

  roles:
    - role: website
      tags: ["website"]
